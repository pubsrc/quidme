name: Update Cloudflare DNS - Prod

on:
  workflow_dispatch:

env:
  TF_ROOT: terraform/environments/prod
  AWS_REGION: eu-west-2

jobs:
  update:
    runs-on: ubuntu-latest
    environment: prod
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN || secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Terraform init (read outputs)
        working-directory: ${{ env.TF_ROOT }}
        run: terraform init

      - name: Resolve DNS targets from Terraform outputs
        working-directory: ${{ env.TF_ROOT }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          if [[ -z "${CLOUDFLARE_API_TOKEN:-}" ]]; then
            echo "Missing GitHub secret CLOUDFLARE_API_TOKEN"
            exit 1
          fi

          FRONTEND_CNAME_TARGET="$(terraform output -raw frontend_cloudfront_domain_name)"
          API_CNAME_TARGET="$(terraform output -raw api_custom_domain_target)"
          FRONTEND_ACM_VALIDATION_RECORDS_JSON="$(terraform output -json frontend_acm_validation_records)"
          API_ACM_VALIDATION_RECORDS_JSON="$(terraform output -json api_acm_validation_records)"

          echo "FRONTEND_CNAME_TARGET=$FRONTEND_CNAME_TARGET" >> "$GITHUB_ENV"
          echo "API_CNAME_TARGET=$API_CNAME_TARGET" >> "$GITHUB_ENV"
          echo "FRONTEND_ACM_VALIDATION_RECORDS_JSON<<EOF" >> "$GITHUB_ENV"
          echo "$FRONTEND_ACM_VALIDATION_RECORDS_JSON" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"
          echo "API_ACM_VALIDATION_RECORDS_JSON<<EOF" >> "$GITHUB_ENV"
          echo "$API_ACM_VALIDATION_RECORDS_JSON" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

      - name: Update Cloudflare records
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_NAME: quidme.uk
          FRONTEND_RECORD_NAME: "@"
          FRONTEND_CNAME_TARGET: ${{ env.FRONTEND_CNAME_TARGET }}
          FRONTEND_PROXIED: "true"
          API_RECORD_NAME: "api"
          API_CNAME_TARGET: ${{ env.API_CNAME_TARGET }}
          API_PROXIED: "false"
          FRONTEND_ACM_VALIDATION_RECORDS_JSON: ${{ env.FRONTEND_ACM_VALIDATION_RECORDS_JSON }}
          API_ACM_VALIDATION_RECORDS_JSON: ${{ env.API_ACM_VALIDATION_RECORDS_JSON }}
        run: ./scripts/update-cloudflare-prod.sh
